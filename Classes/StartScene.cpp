#include "StartScene.h"
#include "SceneManager.h"
#include "GlobalDefine.h"


StartScene::StartScene()
{
}

StartScene::~StartScene()
{
}

bool StartScene::init(const char* filePath)
{
	if (!BaseScene::init(filePath))
	{
		return false;
	}

	/* 播放音乐 */
	PLAY_MUSIC(PATH_BGM_SOUND, true);


	return true;
}

void StartScene::setControllerInBgLayer()
{
	/* 调用父类方法 */
	BaseScene::setControllerInBgLayer();

	/* 获取控件 */
	startGameBtn = dynamic_cast<Button*>(bgLayer->getChildByName(START_SCENE_START_GAME_BTN));
	helpBtn = dynamic_cast<Button*>(bgLayer->getChildByName(START_SCENE_HELP_BTN));
	settingBtn = dynamic_cast<Button*>(bgLayer->getChildByName(START_SCENE_SETTING_BTN));

	/* 设置监听 */
	startGameBtn->addTouchEventListener([&](Ref*, Widget::TouchEventType type) {

		/* 播放音效 */
		if (type == Widget::TouchEventType::BEGAN)
		{
			PLAY_EFFECT(PATH_BUTTON_SOUND, false);
			startGameBtn->runAction(ScaleTo::create(0.1f, 1.1f));
		}

		if (type == Widget::TouchEventType::ENDED)
		{
			/* 第一次进入跳到开始动画场景，否则跳到关卡场景 */
			bool ret = getBoolFromXML(USER_FIRST_ENTER, false);
			startGameBtn->runAction(ScaleTo::create(0.1f, 1.0f));
			this->runAction(DelayTime::create(0.1f));

			if (!ret)	//第一次进入
			{
				setBoolToXML(USER_FIRST_ENTER, true);
				USERDEFAULT->flush();

				SceneManager::getInstance()->changeCurSceneType(SceneType::en_Start_Animation_Scene);
			}
			else		//非第一次
			{
				SceneManager::getInstance()->changeCurSceneType(SceneType::en_Select_Tollgate_Scene);
			}
		}
		
	});

	helpBtn->addTouchEventListener([&](Ref*, Widget::TouchEventType type) {

		/* 播放音效 */
		if (type == Widget::TouchEventType::BEGAN)
		{
			PLAY_EFFECT(PATH_BUTTON_SOUND, false);
			helpBtn->runAction(ScaleTo::create(0.1f, 1.1f));
		}

		if (type == Widget::TouchEventType::ENDED)
		{
			/* 弹出帮助层 */
			helpBtn->runAction(ScaleTo::create(0.1f, 1.0f));
		}

	});

	settingBtn->addTouchEventListener([&](Ref*, Widget::TouchEventType type) {

		/* 播放音效 */
		if (type == Widget::TouchEventType::BEGAN)
		{
			PLAY_EFFECT(PATH_BUTTON_SOUND, false);
			settingBtn->runAction(ScaleTo::create(0.1f, 1.1f));
		}

		if (type == Widget::TouchEventType::ENDED)
		{
			/* 弹出设置层 */
			settingBtn->runAction(ScaleTo::create(0.1f, 1.0f));
		}

	});
}
